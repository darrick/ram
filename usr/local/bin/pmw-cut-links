#!/bin/zsh

##############################################################################
##
## pmw-cut-links
##
## Called from a scheduled macro cart (set up using rdcatch), or
## cron(8) to create Linux hard links from Cut001 to cuts 002, 003,
## and so on (depending on the number-of-links argument passed on the
## command line) in the specified cart.
##
## Basically, the number of hard links to create corresponds to the
## number of local breaks that are available in the program.
##
## See also: rdcatch(1) and the setup for Democracy Now in that
## application.
##
##############################################################################

zmodload zsh/datetime

# Get zsh functions necessary for this script
[[ -r ${ROOT:-/}usr/local/bin/zsh-functions ]] && source ${ROOT:-/}usr/local/bin/zsh-functions

# log STDOUT and STDERR of this script and all commands called by this script to separate files
exec 1> /var/tmp/${0##*/}.out
exec 2> /var/tmp/${0##*/}.err

RM=$(whence rm) ; RM=${RM:-${ROOT:-/}bin/rm}
LN=$(whence ln) ; LN=${LN:-${ROOT:-/}bin/ln}
LOGGER=$(whence logger) ; LOGGER=${LOGGER:-${ROOT:-/}usr/bin/logger}

sndDir=${SND_DIR:-${ROOT:-/}var/snd}

# Get the current weekday name in full (%A).
today=${TODAY:-$(strftime "%A" ${EPOCHSECONDS})}

# The cart number must be the first argument on the command line.
typeset -Z 6 cartNumber
cartNumber=${1}
${LOGGER} --stderr -t ${0##*/} -p local7.err -i "ERROR: No cart number specified on the command line (${?})."
# And the number of hard linked cuts to create.
cutCount=${2}
${LOGGER} --stderr -t ${0##*/} -p local7.err -i "ERROR: Missing the number of cut links to create."

# Make sure the cart file exists.
if [[ -f ${sndDir}/${cartNumber}_001.wav ]] ; then

    typeset -Z 3 cut=2
    while (( cut <= cutCount )) ; do
	${RM} -f ${sndDir}/${cartNumber}_${cut}.wav
	${LN} ${sndDir}/${cartNumber}_001.wav ${sndDir}/${cartNumber}_${cut}.wav
	(( cut++ ))
    done


    if doSQL "update CUTS set PLAY_COUNTER = 0, LOCAL_COUNTER = 0 where CART_NUMBER = ${cartNumber}" ; then
        ${LOGGER} -t ${0##*/} -p local7.info -i "INFO: reset play counter for cart ${cartNumber}."
    else
        ${LOGGER} --stderr -t ${0##*/} -p local7.err -i "ERROR: Could reset play counter for cart ${cartNumber} (${?})."
    fi
else
    ${LOGGER} --stderr -t ${0##*/} -p local7.err -i "ERROR: Could not find audio file ${sndDir}/0${cartNumber}_001.wav (${?})."
fi

exit
